// ==UserScript==
// @name                7zap Reveal Ultra Light Clean Enhanced
// @version             3.8
// @namespace           https://github.com/oumuamuax/7zap-reveal-img-and-codes
// @description         Reveals the part numbers on 7zap, removes image blur, and eliminates premium restriction messages.
// @license             MIT
// @match               https://*.7zap.com/*
// @grant               none
// @run-at              document-end
// @downloadURL https://update.greasyfork.org/scripts/540442/7zap%20Killer%20Reveal%20Enhanced.user.js
// @updateURL https://update.greasyfork.org/scripts/540442/7zap%20Killer%20Reveal%20Enhanced.meta.js
// ==/UserScript==

console.log('7zap Script: Iniciando versión limpia...');

// Variables simples
let isProcessing = false;

// *** DETECCIÓN Y PROCESAMIENTO BÁSICO ***
function processPage() {
    if (isProcessing) return;
    isProcessing = true;

    try {
        // Versión clásica
        var classicElements = document.querySelectorAll('.copyPartNumberWrap:not([data-7zap-done])');
        for(var i = 0; i < classicElements.length; i++) {
            var element = classicElements[i];
            replace_hidden_pn_clean(element);

            if (element.children[1]) {
                element.children[1].setAttribute("href", "https://www.google.com/search?q=" + get_pn_clean(element).replaceAll(" ", "+"));
            }
            if (element.children[0]) {
                element.children[0].setAttribute("onclick", "navigator.clipboard.writeText(\"" + get_pn_clean(element) + "\")");
            }

            element.setAttribute('data-7zap-done', 'true');
            console.log('7zap Script: Procesado clásico limpio:', get_pn_clean(element));
        }

        // Versión moderna - números ocultos
        var strongElements = document.querySelectorAll('strong:not([data-7zap-revealed])');
        for(var j = 0; j < strongElements.length; j++) {
            var strongElement = strongElements[j];
            var text = strongElement.textContent || '';
            if (text.match(/\d+\*+\d*/)) {
                var container = strongElement.closest('.partCodeInCatalog, tr, div');
                if (container) {
                    var onclickElement = container.querySelector('[onclick*="clickToCopyPartNumber"]');
                    if (onclickElement) {
                        var onclick = onclickElement.getAttribute('onclick');
                        var match = onclick.match(/clickToCopyPartNumber\(['"]([^'"]+)['"]\)/);
                        if (match && match[1]) {
                            strongElement.textContent = match[1];
                            strongElement.setAttribute('data-7zap-revealed', 'true');
                            console.log('7zap Script: Revelado moderno:', text, '->', match[1]);
                        }
                    }
                }
            }
        }

    } finally {
        isProcessing = false;
    }
}

// *** FUNCIONES MEJORADAS PARA VERSIÓN CLÁSICA ***
function get_pn_clean(e) {
    var idx_s = e.innerHTML.indexOf("('") + 2;
    var idx_e = e.innerHTML.indexOf("')", idx_s);
    var fullText = e.innerHTML.substr(idx_s, idx_e - idx_s).replaceAll("&nbsp;","");

    // Limpiar el texto - solo tomar la primera parte antes de la coma
    if (fullText.includes("', '")) {
        var cleanNumber = fullText.split("', '")[0];
        return cleanNumber;
    }

    return fullText;
}

function replace_hidden_pn_clean(e) {
    var ret = "";
    var idx_s = e.innerHTML.indexOf("</i>") + 4;
    var idx_e = e.innerHTML.indexOf("&nbsp", idx_s);

    ret += e.innerHTML.substr(0, idx_s);
    ret += get_pn_clean(e); // Usar la función limpia
    ret += e.innerHTML.substr(idx_e);

    e.innerHTML = ret;
}

// *** ELIMINACIÓN DE BLUR MEJORADA Y LIGERA ***
function removeBlur() {
    // Inyectar CSS que elimine blur de cualquier imagen
    var style = document.createElement('style');
    style.id = '7zap-blur-remover';
    style.innerHTML = `
        /* Eliminar blur de cualquier imagen que lo tenga */
        img[style*="blur"],
        img[class*="filter"],
        img[style*="filter"] {
            -webkit-filter: none !important;
            -moz-filter: none !important;
            -ms-filter: none !important;
            -o-filter: none !important;
            filter: none !important;
            opacity: 1 !important;
        }

        /* Ocultar alertas premium */
        .alert-scheme {
            display: none !important;
        }

        /* Detectar clases dinámicas comunes de blur */
        img[class*="c9d225e52d9b4287bc2591ec3fd8a7d06"],
        img[class*="c30fcf14b730c8fb9c9563e9710f605d1"],
        img[class*="9d225e52d9b4287bc2591ec3fd8a7d06"],
        img[class*="30fcf14b730c8fb9c9563e9710f605d1"] {
            -webkit-filter: none !important;
            filter: none !important;
        }
    `;

    if (!document.getElementById('7zap-blur-remover')) {
        document.head.appendChild(style);
        console.log('7zap Script: CSS anti-blur aplicado');
    }

    // También aplicar directamente a imágenes existentes
    var allImages = document.querySelectorAll('img');
    for(var k = 0; k < allImages.length; k++) {
        var img = allImages[k];
        if (!img.dataset.blurChecked) {
            var computedStyle = window.getComputedStyle(img);
            var filter = computedStyle.filter || computedStyle.webkitFilter || '';

            if (filter.includes('blur')) {
                img.style.setProperty('filter', 'none', 'important');
                img.style.setProperty('-webkit-filter', 'none', 'important');
                console.log('7zap Script: Blur eliminado de imagen');
            }
            img.dataset.blurChecked = 'true';
        }
    }
}

// *** OCULTAR ALERTAS PREMIUM SIN INTERFERIR ***
function hideAlerts() {
    // Buscar elementos específicos sin usar TreeWalker
    var alertElements = document.querySelectorAll('.alert-scheme:not([data-7zap-hidden])');
    for(var i = 0; i < alertElements.length; i++) {
        alertElements[i].style.display = 'none';
        alertElements[i].setAttribute('data-7zap-hidden', 'true');
    }

    // Buscar textos específicos de forma más directa
    var textElements = document.querySelectorAll('div, span, p');
    for(var j = 0; j < textElements.length; j++) {
        var text = textElements[j].textContent || '';
        if (text.includes('Users without a premium tariff can view no more than') &&
            !textElements[j].dataset.zapHidden) {
            textElements[j].style.display = 'none';
            textElements[j].dataset.zapHidden = 'true';
            console.log('7zap Script: Mensaje premium oculto');
        }
    }
}

// *** INICIALIZACIÓN SIMPLE ***
setTimeout(function() {
    console.log('7zap Script: Aplicando mejoras...');

    processPage();
    removeBlur();
    hideAlerts();

}, 1000);

// *** OBSERVER MUY BÁSICO ***
var observer = new MutationObserver(function(mutations) {
    var shouldProcess = false;

    for(var i = 0; i < mutations.length; i++) {
        if (mutations[i].addedNodes.length > 0) {
            shouldProcess = true;
            break;
        }
    }

    if (shouldProcess) {
        setTimeout(function() {
            processPage();
            removeBlur();
            hideAlerts();
        }, 500);
    }
});

observer.observe(document.body, {
    childList: true,
    subtree: true
});

// *** VERIFICACIÓN PERIÓDICA MÍNIMA ***
setInterval(function() {
    var classicUnprocessed = document.querySelectorAll('.copyPartNumberWrap:not([data-7zap-done])');
    var hiddenNumbers = document.querySelectorAll('strong:not([data-7zap-revealed])');

    var foundHidden = 0;
    for(var i = 0; i < hiddenNumbers.length; i++) {
        if (hiddenNumbers[i].textContent && hiddenNumbers[i].textContent.includes('*')) {
            foundHidden++;
        }
    }

    if (classicUnprocessed.length > 0 || foundHidden > 0) {
        processPage();
        removeBlur();
    }
}, 10000);

console.log('7zap Script: Configuración limpia completa');
